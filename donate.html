<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="site-title">Donate - SIGNAL PREPARATORY SCHOOL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <link rel="stylesheet" href="donate.css">  
</head>
<body>
    <!-- CMS Admin Button (visible when logged in) -->
    <a href="/admin/" class="cms-admin-btn" id="cmsAdminBtn" style="display: none;">
        <i class="fas fa-cog"></i> <span id="admin-btn-text">CMS Admin</span>
    </a>
    
    <!-- CMS Login Modal -->
    <div class="cms-modal" id="cmsModal">
        <div class="cms-modal-content">
            <h2>Website Administration</h2>
            <p>To access the content management system, please log in with your administrator credentials.</p>
            <button class="cms-modal-btn" onclick="window.location.href='/admin/'">Go to Admin</button>
            <button class="cms-modal-btn cms-modal-close" onclick="closeModal()">Close</button>
        </div>
    </div>

    <nav class="navbar" id="navbar">
        <div class="logo-container">
            <img src="logo.png" alt="Logo" class="logo" id="main-logo">
            <div class="logo-text" id="school-name">SIGNAL PREPARATORY<br>SCHOOL</div>
        </div>
        
        <!-- Modern Hamburger Menu -->
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <!-- Navbar Links -->
        <ul class="nav-links" id="navLinks">
            <li><a href="index.html" class="nav-item">Home</a></li>
            <li><a href="about.html" class="nav-item">About</a></li>
            <li><a href="projects.html" class="nav-item">Projects</a></li>
            <li><a href="address.html" class="nav-item">Contacts</a></li>
            <li><a href="donate.html" class="nav-item"><button class="donate-btn">Donate</button></a></li>
        </ul>
    </nav>
    
    <main class="donate-container">
        <div class="donate-header">
            <h1 id="donate-main-heading">Support Our Cause</h1>
            <p id="donate-subheading">Your contribution helps us make a difference. Every donation counts!</p>
        </div>

        <div class="donate-content">
            <div class="why-donate">
                <h2 id="why-donate-heading">Why Donate?</h2>
                <div id="why-donate-text">
                    <p>Loading content...</p>
                </div>
            </div>
            
            <div class="donate-via">
                <h2 id="donation-methods-heading">Donation Methods</h2>
                <div class="payment-methods" id="payment-methods-container">
                    <!-- Payment methods will be dynamically inserted here -->
                    <p>Loading donation methods...</p>
                </div>
            </div>
        </div>

        <div class="parallax-section">
            <div class="parallax-image" id="donate-parallax-image"></div>
            <div class="parallax-content">
                <h2 id="parallax-heading">Together We Can Make a Difference</h2>
                <p id="parallax-text">Loading content...</p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <!-- Logo and School Name -->
            <div class="footer-column logo-column">
                <div class="logo-container">
                    <img src="logo.png" alt="Signal Preparatory School Logo" class="footer-logo" id="footer-logo">
                    <div class="footer-logo-text" id="footer-school-name">SIGNAL PREPARATORY<br>SCHOOL</div>
                </div>
                <p class="footer-text" id="footer-tagline">Loading content...</p>
                <div class="social-icons" id="social-icons-container">
                    <!-- Social icons will be dynamically inserted here -->
                </div>
            </div>
    
            <!-- Quick Links -->
            <div class="footer-column">
                <h3 class="footer-heading" id="footer-links-heading">Quick Links</h3>
                <ul class="footer-links" id="footer-links-container">
                    <!-- Footer links will be dynamically inserted here -->
                </ul>
            </div>
    
            <!-- Contact Information -->
            <div class="footer-column">
                <h3 class="footer-heading" id="contact-heading">Contact Us</h3>
                <p class="footer-text" id="footer-email">Email: loading...</p>
                <p class="footer-text" id="footer-phone1">Phone: loading...</p>
                <p class="footer-text" id="footer-phone2">Phone: loading...</p>
                <p class="footer-text" id="footer-address">Address: loading...</p>
            </div>
        </div>
    
        <!-- Footer Bottom Section -->
        <div class="footer-bottom">
            <p class="footer-copyright" id="copyright-text">&copy; 2025 Signal Preparatory School. All Rights Reserved.</p>
            <p class="designer-credit" id="designer-credit">Designed by <a href="#" class="designer-link" id="designer-link">loading...</a></p>
            <a href="/admin/" class="admin-link" id="admin-link-text">Admin Login</a>
        </div>
    </footer>

    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Content Loading Script -->
    <script>
        // Function to fetch JSON data with retries
        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    console.log(`Retrying... ${retries} attempts left`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        // Main content loading function
        async function loadContent() {
            try {
                // Try multiple possible JSON paths
                const jsonPaths = [
                    '/src/data/donate.json',
                    '/donate.json',
                    'donate.json',
                    '/data/donate.json',
                    '/static/data/donate.json'
                ];
                
                let data;
                let lastError;
                
                for (const path of jsonPaths) {
                    try {
                        data = await fetchWithRetry(path);
                        break; // If successful, exit the loop
                    } catch (error) {
                        lastError = error;
                        console.warn(`Failed to load from ${path}:`, error);
                        continue;
                    }
                }
                
                if (!data) {
                    throw lastError || new Error('All JSON paths failed');
                }

                // Apply all data to the page
                applyDataToPage(data);
                
            } catch (error) {
                console.error('Error loading content:', error);
                loadFallbackContent();
            }
        }

        function applyDataToPage(data) {
            // Helper function to safely set content
            function setContent(id, content, isHTML = false) {
                const element = document.getElementById(id);
                if (element && content !== undefined) {
                    if (isHTML) {
                        element.innerHTML = marked.parse(content);
                    } else {
                        element.textContent = content;
                    }
                }
            }

            // Helper function to safely set attribute
            function setAttribute(id, attr, value) {
                const element = document.getElementById(id);
                if (element && value !== undefined) {
                    element[attr] = value;
                }
            }

            // Helper function to safely set style
            function setStyle(id, property, value) {
                const element = document.getElementById(id);
                if (element && value !== undefined) {
                    element.style[property] = value;
                }
            }

            // Site-wide content
            setContent('site-title', data.title || 'Donate - SIGNAL PREPARATORY SCHOOL');
            setContent('school-name', data.school_name || 'SIGNAL PREPARATORY SCHOOL');
            setAttribute('main-logo', 'src', data.logo || 'logo.png');
            setAttribute('footer-logo', 'src', data.footer_logo || data.logo || 'logo.png');
            setContent('footer-school-name', data.footer_school_name || data.school_name || 'SIGNAL PREPARATORY SCHOOL');
            setContent('admin-btn-text', data.admin_text || 'CMS Admin');
            setContent('admin-link-text', data.admin_text || 'Admin Login');

            // Donate Header
            setContent('donate-main-heading', data.donate_main_heading || 'Support Our Cause');
            setContent('donate-subheading', data.donate_subheading || 'Your contribution helps us make a difference. Every donation counts!');

            // Why Donate Section
            setContent('why-donate-heading', data.why_donate_heading || 'Why Donate?');
            setContent('why-donate-text', data.why_donate_text || 
                `<p>Your donations help us continue our mission to provide quality education and support to underprivileged children. With your support, we can build a brighter future for the next generation by funding educational programs, school supplies, and infrastructure improvements that directly benefit our students.</p>
                <p>At Signal Preparatory School, we believe every child deserves access to quality education regardless of their background. Your generous contributions help us maintain this vision and expand our impact in the community.</p>`, 
                true);

            // Donation Methods
            setContent('donation-methods-heading', data.donation_methods_heading || 'Donation Methods');
            
            const paymentMethodsContainer = document.getElementById('payment-methods-container');
            if (paymentMethodsContainer) {
                if (data.payment_methods && Array.isArray(data.payment_methods) && data.payment_methods.length > 0) {
                    paymentMethodsContainer.innerHTML = data.payment_methods.map(method => `
                        <div class="payment-method">
                            <i class="${method.icon_class || 'fas fa-money-bill-wave'}"></i>
                            <h3>${method.title || 'Donation Method'}</h3>
                            ${(method.details || []).map(detail => `<p>${detail.detail || ''}</p>`).join('')}
                        </div>
                    `).join('');
                } else {
                    paymentMethodsContainer.innerHTML = `
                        <div class="payment-method">
                            <i class="fas fa-mobile-alt"></i>
                            <h3>MTN Mobile Money</h3>
                            <p>+256 775413318</p>
                            <p>Name: Signal Arts</p>
                        </div>
                        <div class="payment-method">
                            <i class="fas fa-mobile-alt"></i>
                            <h3>Airtel Money</h3>
                            <p>+256754406992</p>
                            <p>Name: Signal Arts</p>
                        </div>
                        <div class="payment-method">
                            <i class="fas fa-university"></i>
                            <h3>Bank Transfer</h3>
                            <p>Centenary Bank</p>
                            <p>Account: 3200054198</p>
                            <p>Name: Signal Arts</p>
                        </div>
                    `;
                }
            }

            // Parallax Section
            setStyle('donate-parallax-image', 'backgroundImage', `url('${data.parallax_image || '/images/uploads/donate.jpg'}')`);
            setContent('parallax-heading', data.parallax_heading || 'Together We Can Make a Difference');
            setContent('parallax-text', data.parallax_text || 'Your support helps us create a better future for everyone. Join us in our mission to bring positive change through education. Every donation, no matter the size, contributes to transforming lives and building a brighter tomorrow for our students and community.');

            // Footer Section
            setContent('footer-tagline', data.footer_tagline || 'Mentoring a coexisting generation with creativity, innovation, and environmental respect.');

            // Social Links
            const socialContainer = document.getElementById('social-icons-container');
            if (socialContainer) {
                if (data.social_links && Array.isArray(data.social_links) {
                    socialContainer.innerHTML = data.social_links.map(link => {
                        const iconClass = getSocialIconClass(link.platform || '');
                        return `<a href="${link.url || '#'}" target="_blank" class="social-icon"><i class="${iconClass}"></i></a>`;
                    }).join('');
                } else {
                    socialContainer.innerHTML = `
                        <a href="https://www.facebook.com/signal.arts.5" target="_blank" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://www.youtube.com/@signalarts85" target="_blank" class="social-icon"><i class="fab fa-youtube"></i></a>
                        <a href="https://www.tiktok.com/@henry.signal.arts" target="_blank" class="social-icon"><i class="fab fa-tiktok"></i></a>
                        <a href="https://www.instagram.com/signalarts1/profilecard/?igsh=MXJ4MjV2ZjBrcTBjeQ==" target="_blank" class="social-icon"><i class="fab fa-instagram"></i></a>
                    `;
                }
            }

            // Footer Links
            const footerLinksContainer = document.getElementById('footer-links-container');
            if (footerLinksContainer) {
                if (data.footer_links && Array.isArray(data.footer_links)) {
                    footerLinksContainer.innerHTML = data.footer_links.map(link => 
                        `<li><a href="${link.url || '#'}" class="footer-link">${link.text || 'Link'}</a></li>`
                    ).join('');
                } else {
                    footerLinksContainer.innerHTML = `
                        <li><a href="index.html" class="footer-link">Home</a></li>
                        <li><a href="about.html" class="footer-link">About</a></li>
                        <li><a href="projects.html" class="footer-link">Projects</a></li>
                        <li><a href="address.html" class="footer-link">Contact Us</a></li>
                    `;
                }
            }

            // Contact Information
            setContent('contact-heading', data.contact_heading || 'Contact Us');
            setContent('footer-email', `Email: ${data.email || 'signalarts1@gmail.com'}`);
            setContent('footer-phone1', `Phone: ${data.phone1 || '+256 775413318'}`);
            setContent('footer-phone2', `Phone: ${data.phone2 || '+256754406992'}`);
            setContent('footer-address', `Address: ${data.address || 'Bwera, Kasese, Uganda'}`);

            // Footer Bottom
            setContent('copyright-text', data.copyright_text || '&copy; 2025 Signal Preparatory School. All Rights Reserved.');
            setContent('designer-credit', data.designer_text || 'Designed by <a href="#" class="designer-link">Darius</a>');
            if (data.designer_link) {
                setAttribute('designer-link', 'href', data.designer_link);
            }
            if (data.designer_name) {
                setContent('designer-link', data.designer_name);
            }
        }

        function getSocialIconClass(platform) {
            const platformLower = platform.toLowerCase();
            if (platformLower.includes('facebook')) return 'fab fa-facebook-f';
            if (platformLower.includes('twitter')) return 'fab fa-twitter';
            if (platformLower.includes('instagram')) return 'fab fa-instagram';
            if (platformLower.includes('youtube')) return 'fab fa-youtube';
            if (platformLower.includes('linkedin')) return 'fab fa-linkedin';
            if (platformLower.includes('tiktok')) return 'fab fa-tiktok';
            return 'fas fa-share-alt'; // default icon
        }

        function loadFallbackContent() {
            console.log('Loading fallback content');
            
            // Fallback content for donate page
            document.getElementById('donate-main-heading').textContent = 'Support Our Cause';
            document.getElementById('donate-subheading').textContent = 'Your contribution helps us make a difference. Every donation counts!';
            document.getElementById('why-donate-heading').textContent = 'Why Donate?';
            document.getElementById('why-donate-text').innerHTML = `
                <p>Your donations help us continue our mission to provide quality education and support to underprivileged children. With your support, we can build a brighter future for the next generation by funding educational programs, school supplies, and infrastructure improvements that directly benefit our students.</p>
                <p>At Signal Preparatory School, we believe every child deserves access to quality education regardless of their background. Your generous contributions help us maintain this vision and expand our impact in the community.</p>
            `;
            document.getElementById('donation-methods-heading').textContent = 'Donation Methods';
            
            // Fallback payment methods
            const paymentMethodsContainer = document.getElementById('payment-methods-container');
            paymentMethodsContainer.innerHTML = `
                <div class="payment-method">
                    <i class="fas fa-mobile-alt"></i>
                    <h3>MTN Mobile Money</h3>
                    <p>+256 775413318</p>
                    <p>Name: Signal Arts</p>
                </div>
                <div class="payment-method">
                    <i class="fas fa-mobile-alt"></i>
                    <h3>Airtel Money</h3>
                    <p>+256754406992</p>
                    <p>Name: Signal Arts</p>
                </div>
                <div class="payment-method">
                    <i class="fas fa-university"></i>
                    <h3>Bank Transfer</h3>
                    <p>Centenary Bank</p>
                    <p>Account: 3200054198</p>
                    <p>Name: Signal Arts</p>
                </div>
            `;
            
            document.getElementById('parallax-heading').textContent = 'Together We Can Make a Difference';
            document.getElementById('parallax-text').textContent = 'Your support helps us create a better future for everyone. Join us in our mission to bring positive change through education. Every donation, no matter the size, contributes to transforming lives and building a brighter tomorrow for our students and community.';
            document.getElementById('donate-parallax-image').style.backgroundImage = "url('/images/uploads/donate.jpg')";
            
            // Fallback footer content
            document.getElementById('footer-tagline').textContent = 'Mentoring a coexisting generation with creativity, innovation, and environmental respect.';
            
            const socialContainer = document.getElementById('social-icons-container');
            socialContainer.innerHTML = `
                <a href="https://www.facebook.com/signal.arts.5" target="_blank" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.youtube.com/@signalarts85" target="_blank" class="social-icon"><i class="fab fa-youtube"></i></a>
                <a href="https://www.tiktok.com/@henry.signal.arts" target="_blank" class="social-icon"><i class="fab fa-tiktok"></i></a>
                <a href="https://www.instagram.com/signalarts1/profilecard/?igsh=MXJ4MjV2ZjBrcTBjeQ==" target="_blank" class="social-icon"><i class="fab fa-instagram"></i></a>
            `;
            
            const footerLinksContainer = document.getElementById('footer-links-container');
            footerLinksContainer.innerHTML = `
                <li><a href="index.html" class="footer-link">Home</a></li>
                <li><a href="about.html" class="footer-link">About</a></li>
                <li><a href="projects.html" class="footer-link">Projects</a></li>
                <li><a href="address.html" class="footer-link">Contact Us</a></li>
            `;
            
            document.getElementById('contact-heading').textContent = 'Contact Us';
            document.getElementById('footer-email').textContent = 'Email: signalarts1@gmail.com';
            document.getElementById('footer-phone1').textContent = 'Phone: +256 775413318';
            document.getElementById('footer-phone2').textContent = 'Phone: +256754406992';
            document.getElementById('footer-address').textContent = 'Address: Bwera, Kasese, Uganda';
            
            document.getElementById('copyright-text').textContent = '&copy; 2025 Signal Preparatory School. All Rights Reserved.';
            document.getElementById('designer-credit').innerHTML = 'Designed by <a href="https://dariusmumbere.github.io/personal" class="designer-link">Mumbere Darius</a>';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Skip if in admin interface
            if (window.location.pathname.includes('/admin/')) return;

            // Load content
            loadContent();

            // Modern toggle menu with animation
            const hamburger = document.getElementById('hamburger');
            const navLinks = document.getElementById('navLinks');
            
            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
                document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : '';
            });
            
            // Close menu when clicking on a link
            document.querySelectorAll('.nav-item').forEach(link => {
                link.addEventListener('click', () => {
                    hamburger.classList.remove('active');
                    navLinks.classList.remove('active');
                    document.body.style.overflow = '';
                });
            });
            
            // Navbar scroll effect
            const navbar = document.getElementById('navbar');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });
            
            // Netlify Identity and CMS Integration
            if (window.netlifyIdentity) {
                window.netlifyIdentity.on("init", user => {
                    if (!user) {
                        window.netlifyIdentity.on("login", () => {
                            document.location.href = "/admin/";
                        });
                    }
                });
                
                // Check if user is logged in
                const currentUser = netlifyIdentity.currentUser();
                if (currentUser) {
                    document.getElementById('cmsAdminBtn').style.display = 'flex';
                }
                
                // Listen for login events
                netlifyIdentity.on('login', user => {
                    document.getElementById('cmsAdminBtn').style.display = 'flex';
                    closeModal();
                });
                
                // Listen for logout events
                netlifyIdentity.on('logout', () => {
                    document.getElementById('cmsAdminBtn').style.display = 'none';
                });
            }
            
            // Modal functions
            function openModal() {
                document.getElementById('cmsModal').style.display = 'flex';
            }
            
            function closeModal() {
                document.getElementById('cmsModal').style.display = 'none';
            }
            
            // Admin link click handler
            document.querySelector('.admin-link').addEventListener('click', function(e) {
                e.preventDefault();
                openModal();
            });
            
            // Close modal when clicking outside
            document.getElementById('cmsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
